## IP首部

![image-20230213215446980](assets/IP%E7%BD%91%E9%99%85%E5%8D%8F%E8%AE%AE/image-20230213215446980.png)

普通IP首部长度为20个字节，除非含有选项字段。



最高位在左边，即0bit；最低位在右边，即：31bit。

0-31bit，共32bit，以一个次序进行传输（big endian字节序或网络字节序）：

1. 0~7bit
2. 8~15bit
3. 16~23bit
4. 24~31bit



各个字段：

1. 版本号

2. 首部长度，指的是IP首部的长度，以32位字为单位。

   2进制的1111 = 10进制的15，即该字段能够表示的首部的最大长度为15个32位字长，15 * 32bit = 480bit，480bit / 8bit = 60byte。

3. TOS包括：

   * 一个3bit的优先权子字段（现在已经被忽略）

   * 4bit的TOS（Type Of Service，服务类型）子字段，分别代表：

     * 最小时延
     * 最大吞吐量
     * 最高可靠性
     * 最小费用

     只能使用其中1bit，如果4bit均为0，那么就意味着是**一般服务**。

     ![image-20230213223216608](assets/IP%E7%BD%91%E9%99%85%E5%8D%8F%E8%AE%AE/image-20230213223216608.png)

   * 1bit未用位，但必须置零

   4. 总长度，指的是整个IP数据报的长度，以字节为单位。

      由于该字段长16比特，因此IP数据报最长可达65535字节。当IP数据报被分片时，该字段的值也随着变化。虽然MTU可以为65536，但是大多数链路成都会对这种长度的数据包进行分片（主机要求不能接收超过576字节的数据报）。

      该字段是IP首部中必要的内容，原因如下：

      * 链路层需要根据该字段判断是否需要填充数据？填充多少数据？以达到帧的最小长度。——以太网的最小帧长为46字节。
      * 当数据链路层填充了一些数据达到了数据帧最小长度46字节后，IP层要根据该字段获取到没有被填充之前的真实的IP数据报的长度是多少。

   5. 标识字段，唯一地标识主机发送的每一份数据报。通常没发送一份报文他的值就会+1。

   6. TTL字段，设置了数据报可以经过的最多路由器数。

      初始值由源主机设置，数据报经过一个路由器，这个值就-1，当为0的时候，数据报就被丢弃。

   7. 协议字段，根据他可以识别是哪个协议向IP传送数据。

   8. 首部检验和字段，根据IP首部计算的检验和码。

      总而言之，就是用来判断数据传输过程中是否出现了差错的，不管他是怎么检验的。检验和错误的时候，不产生查错报文，由上层去发现丢失的数据报并进行重传。

   9. 源地址，从哪来的。

   10. 目的地址，到哪去。

   11. 选项，一个可变长的可选信息。

       很少被使用，并非所有的主机和路由器都支持这些选项。

## 路由选择

IP层在内存中有一个路由表。

* 目的IP地址
* 下一跳路由器的IP地址
* 标志
* 为数据包的传输指定一个网络接口





