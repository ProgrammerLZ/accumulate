# Redis集群

**Redis Cluster**是官方提供的专有的Redis分布式解决方案,有效地解决了Redis分布式方面的需求,当遇到单机内存、并发、流量等瓶颈时，可以采用该方案达到负载均衡的目的。它非常优雅地解决了Redis集群方面的问题，因此理解应用好Redis Cluster将极大地解放我们使用分布式Redis的工作量。



## 数据分布

### 数据分布式理论

分布式数据库首先要解决把整个数据集按照**分区规则**映射到多个节点的问题，即把数据集划分到多个节点上，每个节点负责整体数据的一个子集。

<img src="Redis的集群.assets/image-20220624092844249.png" alt="image-20220624092844249" style="zoom:50%;" />

分区规则常见的有：

* 哈希分区
* 顺序分区

Redis Cluster采用哈希分区。

#### 哈希分区

哈希分区的分区方式有以下几种：

1. 节点取余分区

   <img src="Redis的集群.assets/image-20220624133850156.png" alt="image-20220624133850156" style="zoom:50%;" />

   这种方式是通过公式计算出数据所在节点，公式如下：hash(key) % N

   优点：

   * 简单

   缺点：

   * 当节点数量变化（扩容、缩容），数据节点映射关系需要重新计算

2. 一致性哈希分区

   <img src="Redis的集群.assets/image-20220624140220164.png" alt="image-20220624140220164" style="zoom:50%;" />

   实现思路是为系统中每个节点分配一个token，范围一般在0~2^32，这些token构成一个哈希环。数据读写执行节点查找操作时，先根据key计算hash值，然后顺时针找到第一个大于等于该哈希值的token节点。

3. 虚拟槽分区

   <img src="Redis的集群.assets/image-20220624140315578.png" alt="image-20220624140315578" style="zoom:50%;" />

   虚拟槽分区巧妙地使用了哈希空间，使用**分散度良好的哈希函数**把所有数据映射到一个固定范围的整数集合中，整数定义为槽(slot)。这个范围一般远远大于节点数，比如Redis Cluster槽范围是**0~16383**。槽是集群内数据管理和迁移的基本单位。采用大范围槽的主要目的是为了方便数据拆分和集群扩展。每个节点会负责一定数量的槽。

   Redis Cluster采用虚拟槽分区。计算数据在哪个slot的公式：slot=CRC16(key)&16383。一个节点负责维护一部分槽以及槽所映射的键值数据，如下图所示。

   <img src="Redis的集群.assets/image-20220624153520548.png" alt="image-20220624153520548" style="zoom:50%;" />



## 结点通信

### 通信流程

在分布式存储中需要提供维护节点元数据信息的机制，元数据指的是：**节点负责哪些数据，是否出现故障等状态信息**。

维护元数据的方式分为：

* 集中式
* P2P

Redis采用的是P2P的方式。

1. 集群中的每个节点都会单独开辟一个TCP通道，用于节点之间彼此通信，通信端口号在基础端口上加10000。
2. 每个节点在固定周期内通过特定规则选择几个节点发送ping消息。
3. 接收到ping消息的节点用pong消息作为响应。







## 集群伸缩

### 伸缩原理

从最抽象的层面上来看Redis集群的伸缩原理：集群伸缩=槽和数据在节点之 间的移动。

<img src="Redis的集群.assets/image-20220629094505194.png" alt="image-20220629094505194" style="zoom:50%;" />

































