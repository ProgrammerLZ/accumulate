# DDD学习-事件风暴

## 目的

在真实项目，尤其是敏捷项目里，领域专家很可能不会像我们上一讲那样，一开始就把需求都一一列出来，需求可能仅仅停留在领域专家的脑子里。所以，我们就需要一种方法，能够将这些头脑中的需求挖掘出来。

而且，即便领域专家已经把需求写出来，我们也很难保证没有遗漏，保证开发人员都彻底理解了。而事件风暴不仅能帮助我们尽量把需求补充完全，而且还能以协作的方式保证业务人员和技术人员对需求理解一致。

此外，事件风暴方法也能够帮助我们识别领域对象。



## 什么是事件风暴

*一般来说，为了理解需求，我们首先要**分析系统具有哪些功能**，这些功能由什么人操作，会产生什么效果。这个过程传统上叫做“捕获行为需求”。*捕获行为需求的方法包括：

* Use Case
* Event Storming 

他简单易学，充分体现沟通协作、统一语言的要点。



## 事件风暴的过程

<img src="assets/%E4%BA%8B%E4%BB%B6%E9%A3%8E%E6%9A%B4/ea006b757ab0b2aeff0d888128f9d31b.jpg" alt="img" style="zoom: 25%;" />

1. 识别领域事件。

   找到业务流程中发生了哪些事情

2. 识别命令。

   进一步说明是什么角色，做了什么操作，导致上述事情的发生

3. 识别领域名词

   从领域事件和命令中找到名词性概念，为进一步的领域建模打下基础



### 开始前的准备

**人员准备**

* 领域专家
  * 业务部门专家
  * 产品经理
  * PO
  * BA
* 技术人员
  * 架构师
  * 技术经理
  * 其他开发人员、测试人员

**场地准备**

* 一个**大**会议室

**器材准备**

* 几套彩色的便利贴

  把事件风暴的主要内容写在上面

* 一卷一开的大白纸

  白纸打横，一字排开，贴在会议室的墙上，用来贴便利贴



### 识别领域事件

所谓领域事件，就是在业务过程中，**业务人员要关注的**那些已经发生的事儿。比方说，对于电子商务系统，订单已提交、商品已签收等等，都是领域事件。实际上，领域事件表示的是，**业务流程中每个步骤引发的结果**。事件风暴的作者认为，**从结果入手来梳理需求，比从操作入手，更容易把业务想清楚**。事件风暴中的“事件”两个字就来源于领域事件。

> 这里很重要的是，领域事件是业务人员比较关注的，主要强调的是业务人员的视角。业务人员不关心的事情，不能够算作领域事件。

另外，还要注意领域事件的命名，如果套用英语的语法来说，一般是**完成时 + 被动语态**。比如说，订单已提交。

关于领域事件，要注意：

* 不要把技术事件当成领域事件。**领域事件一定要是领域专家所关注的，用的是业务术语**。像数据库事务已回滚、缓存已命中之类的技术术语，不是领域事件，不在这个阶段讨论。
* 查询功能不算领域事件。领域事件应该是对某样事物产生了影响，并被记录的事情。一般是某个事物的创建、修改和删除。还有一种情况是向其他人或者系统发消息，例如“通知邮件已发送”也算领域事件，因为接收方可能会通过进一步处理来影响某些事物。

下图是企业管理系统中识别出的所有领域事件。

![img](assets/%E4%BA%8B%E4%BB%B6%E9%A3%8E%E6%9A%B4/5d11a968155ea6bd40f0e4d8a6c9a99e.jpg)

注意在上图中，有些业务规则和领域事件在需求讲解阶段领域专家是没有讲解出来的，但是在事件风暴的过程中被我们挖掘了出来。比如：工时登记中的一些业务规则。

另外，客户已添加的时候自然就分配了一个客户经理，无需搞出一个分配客户经理的操作。



### 识别命令

**所谓命令（command），就是引发领域事件的操作，我们可以通过分析领域事件得到**。除了识别出命令本身以外，我们通常还要识别出**谁执行的命令**，以及为了执行命令我们要**查询出什么数据**。

下图是识别出的部分命令。

![img](assets/%E4%BA%8B%E4%BB%B6%E9%A3%8E%E6%9A%B4/8d2020e9710a44ff5b92b7cd272f72c8.jpg)

注意，从上图中可以看出：

* 有些命令可能没有查询数据
* 有的命令会有多个查询数据
* 有的命令会有多个执行者
* 执行者是某个角色，而不是具体的人



### 识别领域名词

识别领域名词可以分为两个小步骤：

1. 挪动“识别命令”步骤中的便利贴，把围绕同一个名词的命令、事件、执行者、查询数据摆在一起，分成好几“堆”。
2. 把领域名词写在大一点的黄色便利贴上，贴在每堆便利贴的中间。

下图是识别出的所有领域名词。

![img](assets/%E4%BA%8B%E4%BB%B6%E9%A3%8E%E6%9A%B4/61ba53b6fa9700f19d0d4066aca5afd7.jpg)

![img](assets/%E4%BA%8B%E4%BB%B6%E9%A3%8E%E6%9A%B4/9770c0063b26fd5f7cea6c3ae91e842e.jpg)



## 细谈事件风暴

### 事件风暴的作用

1. 领域事件。从代码实现的角度来看，**领域事件一般会对应一段代码逻辑，这段逻辑可能会最终改变数据库中的数据**。另外，在事件驱动的架构中，一个领域事件可能会表现为一个向外部发送的异步消息。
2. 命令。领域建模时，我们可以通过对命令的走查（walkthrough），细化和验证领域模型。在实现层面，**一个命令可能对应前端的一个操作，例如按下按钮；对于后端而言，一个命令可能对应一个 API**。
3. 执行者。在领域建模时，执行者可能本身就是一个领域对象，也可能是领域对象充当的角色，或者是权限管理中的一个角色。
4. 查询数据。每个查询数据，就对应着一个查询功能。不过，这里的查询数据是为了某个命令服务的。系统中可能还有一些单纯的查询功能，并不与某个特定的命令绑定。这些查询功能不会通过事件风暴识别出来，需要单独进行分析。
5. 领域名词。识别领域名词的最终目的是要**找到领域模型中的对象**。在这一步里识别出的名词，虽然很可能就是领域对象，但也未必。一个名词有可能只是一个对象充当的角色，或者对象的属性，还有些名词需要经过合并或拆解后，才是合理的领域对象，而这些需要等到领域建模时才能真正搞清楚。



### 事件风暴的常见问题

1. 在事件风暴里是否要列出所有的领域事件和命令？

   **在事件风暴里只列出主要的、足以用于表达和交流领域知识的步骤**，例如签订合同、生效合同等等。而像修改合同和删除合同这样的步骤是显而易见的，在讨论过程中可以提一下，但不必真的列出来，这样是为了保持简洁。

2. 各个领域事件需要体现严格的时间顺序吗？

   只需要按照大致的顺序，贴出领域事件就可以了。这是因为，如果要体现严格的时间顺序，需要用到更复杂的符号，例如条件判断，还有要画更多的连线，这**会使事件风暴变得非常繁琐**。因此，我们应该关注点分离。如果要体现严格的时间顺序，我们可以用流程图、用顺序图等方法，但**事件风暴不必关注**这一点。

3. 每个步骤的颗粒度应该有多大？比如说，“签订合同”这个命令，在具体操作的时候，可能分成*录入合同基本信息、录入合同明细、上传附件等等*更小的步骤。那么，我们需要为每一个小步骤都识别出领域事件和命令吗？

   **这就要考虑从业务的角度，我们是把每个小步骤都当作独立的一个事务来看待，还是把它们合起来作为同一个事务**。另外，可以设想，如果每个小步骤都向外界发出一个领域事件，对系统后续的功能是不是有意义。那么在目前的需求里，合同作为一个整体来提交就可以了，分成小的领域事件，并没有意义，所以不再分成更小的步骤了。在实践里，有时仍然会有模棱两可的情况，这时，**原则上宜粗不宜细**。可以先采用比较大的颗粒度。后面必要的时候，再拆细，就可以了。

4. 事件风暴适用于所有项目吗？

   1. **事件风暴主要应用在需求不清晰，或者理解不统一的情况下，通过协作的方式理清业务、达成一致，所以通常对于新项目比较适用**。至于遗留系统改造的情况，如果这个系统的**知识已经流失得很严重**，那么事件风暴仍然是有意义的。但如果大家对这个系统的业务知识很清楚，只是要进行架构改造，那么事件风暴的意义就不大了。

   2. 即便在适用的场合，事件风暴也不是唯一的方法，我们还可以用用例分析、用户故事等方法实现类似的目的。只要抓住协作、统一语言等等要点，这些方法都可以用在 DDD 的项目里。

5. 怎么保存和维护事件风暴的结果？

   一般来说，我们可以在事件风暴的过程中专门安排一个记录员，由他使用 PPT 之类的画图工具，把贴在纸上的内容重新画一遍，就可以实现电子化的保存了。

6. 事件风暴是不是需要长期维护和更新？

   如果事件风暴的内容最终会反映到**用户故事、用例、功能列表**等产出物中，而这些产出物会进行维护，那我们就不必专门更新事件风暴的产出物了，只在需要的时候作为一种沟通工具，将电子化的结果作为一种中间产物保存就可以了。如果你的团队并没有用户故事和用例等保存行为需求的方式，那么我建议你对事件风暴进行维护和更新。

7. 怎么保存领域规则？

   **领域规则是重要的领域知识，必须妥善保存**。在事件风暴的过程里我们已经识别出了一些领域规则，在后续的领域建模阶段，可能还会识别出更多。如果只是写在便利贴上，或者画在图上，时间长了，就很难维护了。所以，我们要编一个领域规则表，把所有的领域规则都汇总在里面，然后再把领域规则表和领域模型放在一起，作为领域知识的重要组成部分，下图就是一个例子。

   ![img](assets/%E4%BA%8B%E4%BB%B6%E9%A3%8E%E6%9A%B4/c907a49f0bfc5f25d8f4207655eea9bc.jpg)































































