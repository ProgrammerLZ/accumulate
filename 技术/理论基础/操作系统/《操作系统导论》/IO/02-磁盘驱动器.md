# 磁盘驱动器

==关键问题：如何存储和访问磁盘上的数据？==

==现代磁盘驱动器如何存储数据？接口是什么？数据是如何安排和访问的？磁盘调度如何提高性能？==



## 接口

驱动器由大量扇区（512字节块）组成，每个扇区都可以读取或写入。在具有n个扇区的磁盘上，扇区从0到n−1编号。因此，我们可以将磁盘视为一组扇区，0到n−1是驱动器的地址空间（address space）。



许多文件系统一次读取或写入**4KB**（或更多）。但是，在更新磁盘时，驱动器制造商唯一保证的是单个**512**字节（一个扇区）的写入是原子的（atomic，即它将完整地完成或者根本不会完成）。因此，如果发生不合时宜的掉电，则只能完成较大写入的一部分。



客户端的假设：

* 通常可以假设访问驱动器地址空间内两个彼此靠近的块将比访问两个相隔很远的块更快
* 访问连续块（即顺序读取或写入）是最快的访问模式，并且通常比任何更随机的访问模式快得多



## 基本几何形状

我们从一个**盘片**（platter）开始，它是一个圆形坚硬的表面，通过引入磁性变化来永久存储数据。磁盘可能有一个或多个盘片。每个盘片有两面，每面都称为表面。



所有盘片都围绕主轴（spindle）连接在一起，主轴连接到一个电机，以一个恒定（固定）的速度旋转盘片（当驱动器接通电源时）。旋转速率通常以每分钟转数（Rotations Per Minute，RPM）来测量，典型的现代数值在7200～15000 RPM范围内。



数据在扇区的同心圆中的每个表面上被编码。我们称这样的同心圆为一个**磁道**（track）。一个表面包含数以千计的磁道，紧密地排在一起，数百个磁道只有头发的宽度。



读写过程由**磁头**（disk head）完成；驱动器的每个表面有一个这样的磁头。磁头连接到单个磁盘臂（disk arm）上，磁盘臂在表面上移动，将磁头定位在期望的磁道上。



## 简单的磁盘驱动器

![image-20230217122504836](assets/%E7%A3%81%E7%9B%98%E9%A9%B1%E5%8A%A8%E5%99%A8/image-20230217122504836.png)

* 一个盘片
* 该盘片只有一个简单的单个磁道
* 磁道有12个扇区
* 每个扇区512字节
* 电机连接到主轴
* 一个连接到磁盘壁的磁头



### 旋转时延

请想象我们现在收到读取块0的请求。

磁盘驱动器必须等待期望的扇区旋转到磁头下。这种等待在现代驱动器中经常发生，并且**是I/O服务时间的重要组成部分**，它有一个特殊的名称：旋转延迟。

如果完整的旋转延迟是R，那么磁盘必然产生大约为R/2的旋转延迟，以等待0来到读/写磁头下面



### 多磁道：寻道时间

![image-20230217123706175](assets/%E7%A3%81%E7%9B%98%E9%A9%B1%E5%8A%A8%E5%99%A8/image-20230217123706175.png)

磁头一开始在30号扇区，假设要读取扇区11（最外圈的磁道）。



为了服务这个读取请求，驱动器必须首先将磁盘臂移动到正确的磁道，通过一个所谓的**寻道**（seek）过程。寻道，以及旋转，是**最昂贵的磁盘操作之一**。

寻道有许多阶段：

1. 首先是磁盘臂移动时的加速阶段。
2. 然后随着磁盘臂全速移动而惯性滑动。
3. 然后随着磁盘臂减速而减速。
4. 最后，在磁头小心地放置在正确的磁道上时停下来。



寻道之后，磁盘臂将磁头定位在正确的磁道上。



磁盘臂已经移动到所需的磁道上，并且盘片在这个过程中也一直在旋转，在这个例子中，大约旋转了3个扇区。因此，扇区9即将通过磁头下方，我们只能承受短暂的转动延迟，以便完成传输。



当扇区11经过磁盘磁头时，I/O的最后阶段将发生，称为传输（transfer），数据从表面读取或写入表面。



完整的I/O时间图：

1. 首先寻道
2. 然后等待转动延迟
3. 最后传输。