# 日百万交易的支付系统，JVM内存的设置

这种交易量的系统一般是国内的互联网大厂，他所面临的技术难题有很多，比如：

* 高并发访问
* 高性能处理请求
* 大量的支付订单数据的存储
* 等等其他很多的问题

但是，以上都是系统架构层面要考虑的东西，在JVM的主题下，以上全都先忽略调，主要考虑JVM的问题。



## JVM堆内存大小的设置

### 面临的主要问题

JVM主要面临的问题是：**在如此高并发的访问系统的情况下，要频繁的创建和销毁支付订单**。因此，会涉及到一些比较核心的问题如下：

* 支付系统需要部署多少台机器？
* 每台机器要多少内存空间？
* 每台机器上启动的JVM要分配多大的内存空间？才能够支撑这么多的订单对象在内存中创建，而不会由于内存不够导致直接崩溃？



### 几个关键性的预估指标

* **每秒产生多少笔支付订单**

  日百万交易量，每天的交易是有一个高峰期的，因此白百万交易量平摊在那几个小时上，基本每小时的并发量差不多是100左右。也就是大概每秒会创建100个支付订单。

  假设订单系统部署在3台机器上，那么每台机器分摊30笔支付订单。

* **每笔支付订单处理耗时需要多久**

  假设为1s。

* **每个支付订单占用多少内存空间**

  根据支付订单对象的实例变量类型去判断。假设为500字节。

* **每秒产生的支付订单对内存的占用情况**

  30 * 500字节 = 15000，约为15kb。



### 加上除支付核心流程之外产生的其他业务对象，整体进行评估

将15kb扩大70倍。意味着一秒内共计产生了于支付订单对象20倍左右的对象，大概是 15 * 70 =1050kb左右，约为1MB。



### 根据以上预估，判断支付系统的JVM堆内存应该如何设置

> 注意：频繁的young GC是不好的，会在垃圾回收章节讨论这个事情。

**如果是2核4G的机器配置。**

JVM能被分配到的内存：2G。

堆内存能被分配的到的内存：1G。

新生代，老年代，能分配的内存区域，差不多各是几百M，假设各500M。

那基本系统跑个400多秒新生代就满了，此时就会触发young gc，几百秒产生一次young gc这种频率可是不太好的，频繁的young gc会对系统的稳定产生影响。

结论：2核4G的机器配置有些不够用。上4核8G好一点。	



**以上仅代表一个思路，并不是非常严谨**。基于这种估算方式并结合一些工具，在系统上线前给出合理的机器配置以及JVM内存参数设置，是一个合格的高级工程师应该具备能力。



## JVM栈内存与永久代大小的设置





## 小思考

业务的落地实现，是工程师最基本的能力，是初级工程师应该具备的能力。但是，当想要向高级工程师和架构师进行发展的时候，要多注意一些除了业务之外的东西。

业务开发人员，开发完成之后几乎就可以退场了，以后系统跟你就几乎没啥关系了，所以专注于业务开发的人更像是一锤子的买卖，是不长久的，只是具备业务开发的能力是远远不够的。

也就是说，业务开发能力，仅仅是最初级的能力。除此之外，还要多关注：

* 系统各项关键指标的预估能力，比如：JVM内存、磁盘大小、网络带宽、数据库压力等。
* 理解业务并实现架构设计的能力

这样，只要系统还存在一天，就少不了你这个技术人。

总而言之，**要专注在整个领域的关键区域上，这样才能成为关键人物，只有关键人物是不可或缺的，是不容易被替代的，是更能够实现个人价值的。**反过来，只有重要的人才会被安排在关键的位置上。因此，最需要做的还是要提升个人能力，让自己的能力能够跟关键位置进行匹配。













