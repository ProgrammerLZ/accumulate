## 大泥球

大泥球没有分离代码的关注点，从而使不同关注点的代码混在一起，这样就会造成下面几个问题：

* 很难单独识别出反映领域逻辑的代码，从而难以保证与领域模型的一致性；
* 应该内聚的代码不内聚，应该解耦的代码不解耦，造成代码难以理解；
* 修改业务代码会影响技术代码，反过来也一样；
* 代码维护一段时间后，变得日益混乱，成了一团大泥球；

<img src="assets/%E5%88%86%E5%B1%82%E6%9E%B6%E6%9E%84/bd8b9309d84bc82284183257128ef39b.jpg" alt="img" style="zoom:25%;" />

分层架构是解决大泥球的关键手段，分层架构一个重要的原则是：**代码中不稳定的部分应该依赖稳定的部分**。所以，分层架构中越是内层，就越稳定，越是外层，相对就越容易变化。



## 分离领域

DDD强调要将领域层分离出来，领域层封装了领域逻辑和数据。领域层分离出来后，才能保证与领域模型保持一致，并且独立的进行演化。

<img src="assets/%E5%88%86%E5%B1%82%E6%9E%B6%E6%9E%84/0e06b4f4eb72bbd3fd26984c6cbed726.jpg" alt="img" style="zoom: 25%;" />

>  新概念：*领域逻辑*。



## 领域层的门面

领域层封装的逻辑是细粒度的，不适合直接作为API暴露给外部。并且，有些不属于领域层的横切关注点也应该从领域层剥离出去，比如：事务控制。因此，在领域层的外层又产生了新的一层，DDD和六边形架构都将其称为Application——应用层，应用层是领域层的门面。

<img src="assets/%E5%88%86%E5%B1%82%E6%9E%B6%E6%9E%84/13495747e01b6241e7ed55849b287a78.jpg" alt="img" style="zoom:25%;" />

Application层主要负责：

* 接收来自用户的请求，调用和协调领域层的逻辑来实现应用逻辑；
* 将领域层的处理结果封装为更简单的粗粒度对象——通常是DTO，作为对外的API的结果或者参数；
* 负责处理一些横切关注点，例如：事务、日志、权限等；

从设计模式的角度来说，Application层相当于Domain层的门面。

应用层**不包含领域逻辑**，只是对领域逻辑进行封装和编排，可以把应用层的逻辑称为**应用逻辑**。封装应用逻辑的类没有状态，只有方法，称为**应用服务**。

> 新概念：*应用逻辑、应用服务*



## 适配器

### 用适配器处理输入输出

除了业务功能之外，应用当中还有另外一个关注点：输入输出。为了分离这个关注点，在应用层之外又出现了一个新的层，专门用于处理输入输出技术，六边形架构中称其为：Adapter——适配器。

<img src="assets/%E5%88%86%E5%B1%82%E6%9E%B6%E6%9E%84/3c68f2805774e9a8450aea3fe2053e40.jpg" alt="img" style="zoom:25%;" />

输入可以是RestFull Api也可以是RPC，Adapter可以为Application屏蔽掉这种技术上的差异，Application完全不知道系统的输入是以什么技术实现的。也就是说适配器层屏蔽了输入输出技术的差异，从而使应用层与具体技术无关，这样就达到了分离关注点的目的。

> 输入输出属于技术细节。



### 用适配器处理数据持久化

DDD中有一种模式叫做：Repository——仓库。该模式用于封装数据持久化代码，可以与传统的DAO作类比，但是他们之间存在一定的差异。仓库是以聚合为单位的，每个聚合有一个Repository；而DAO是以表为单位，一个表就有一个DAO。

数据库持久化操作设计到很多的技术细节，比如ORM、不同的RDMS，这些都属于持久化相关的技术细节，与输入输出一样，都应该从业务逻辑当中剥离出来。那么，仓库就可以充当适配器，将数据访问相关的具体技术与Application分离开。

Repository与Controller不同的是，Controller处理外界向系统内的调用，而Repository处理系统向外的调用。六边形架构中把处理向外调用的适配器称为：driving adapter——主动适配器，向内调用的适配器称为：driven adapter——被动适配器。

<img src="assets/%E5%88%86%E5%B1%82%E6%9E%B6%E6%9E%84/cc90436094e6003977c43696e2ccc797.jpg" alt="img" style="zoom:25%;" />

> 数据库访问属于技术细节。



## 公共层

到现在为止，我们已经讲了 DDD 分层架构中最主要的几层，但还有另外一些代码没有考虑。比如说，我们写了一些用于字符串和日期处理的工具类，这些工具可能被上面说的任何一层调用。又比如说，我们可能对 Spring 框架进行薄薄的一层封装，以便更适合自己的产品使用，甚至可以写一些自己的小框架，这些框架性的代码也可能用于上面说的任何一层。

既然这些代码可能被前面的所有层依赖，那么是不是说，这些代码应该处于整个系统的最内层呢？如果这样做，那么和 DDD 所强调的以领域层为核心的思想就矛盾了。但如果不这么做，是不是又违反了层间依赖原则呢？事实上，我们可以认为这些代码和前面说的各层根本不在同一个维度，它们是对各层代码起到公共的支撑作用的。用下面这张图比较容易说明这个思路：

<img src="assets/%E5%88%86%E5%B1%82%E6%9E%B6%E6%9E%84/81ae6138c8308928edf3c95e96437398.jpg" alt="img" style="zoom:25%;" />



## 没有银弹，关键在于权衡

![img](assets/%E5%88%86%E5%B1%82%E6%9E%B6%E6%9E%84/3f66b8a9yy030b44cd93392yy51ea8f6.jpg)



课后扩展：

* 门面模式
* 适配器模式
* 六边形架构

