# DDD学习——领域建模

建立**领域模型**是DDD的核心。

## 一些基本概念

### 领域对象

领域建模的2个主要目的：

* 将知识**可视化**，准确、深刻地反映领域知识，并且在业务和技术人员之间达成一致
* 指导系统的设计和编码，也就是说，领域模型应该能够比较容易地转化成数据库模式和代码实现

为了完成上述的两个目的，其主要的一些活动包括：

* 识别领域对象（domain object）
* 分析领域对象之间的关系
* 记录对象的关键属性
* 复杂情况下还要将领域对象组织成模块

系统中要处理的各种“事物”就是**领域对象**。比如说项目、员工、账户等等。这些对象都反映了名词性的概念。其中，有些名词化了的动词也是领域对象。比如说我们进行了一笔支付操作，并且想把这笔操作记录下来。这时，“支付”也是领域对象。支付本来是动词，但这里实际上是要把一笔支付的信息记录下来，在这里就把“支付”当名词用了。



### 领域模型图

领域模型是用领域模型图来表达的，通常用UML来画。在UML中，**一个类通常与一个领域对象相对应**。



### 实体

DDD中，领域对象被分为**实体和值对象**，目前暂且只关注实体，也就是说**就目前来说，一个实体对应一个领域对象**。



### 类图

这个咋理解都行。我就理解成UML画出来的图就叫做类图，他表达了类之间的关系（也就意味着同时也表达了领域对象之间的关系，也就意味着同时也表达了实体之间的关系）。





## 领域建模

### 初步识别实体

可以从领域风暴阶段识别的领域名词入手，分成几部分来建模。先考虑**租户、组织和人员**。领域风暴中的图是这样的：

<img src="assets/%E9%A2%86%E5%9F%9F%E5%BB%BA%E6%A8%A1/7e06fc4de6c1b257bfa024d81c1yy45d.jpg" alt="img" style="zoom:25%;" />

可以**先假定（这是一种比较粗暴的方式，之后还会有比较详细的分析）**每个领域名词都是一个实体，把它们用类的符号画出来。

<img src="assets/%E9%A2%86%E5%9F%9F%E5%BB%BA%E6%A8%A1/44f07dee31058e65751607990620e9ed.jpg" alt="img" style="zoom:24%;" />

在领域建模阶段，我们主要关注的是实体和它们之间的关系，不关心他们的属性。



### 分析实体间的关系

#### 一对一

<img src="assets/%E9%A2%86%E5%9F%9F%E5%BB%BA%E6%A8%A1/f667be3c6cfbf87c89d89069542a7559.jpg" alt="img" style="zoom:24%;" />

#### 一对多

<img src="assets/%E9%A2%86%E5%9F%9F%E5%BB%BA%E6%A8%A1/7f8ebfb9ec0389e86162c15e3c109d5c.jpg" alt="img" style="zoom:24%;" />



越多，图就越杂乱。也就是说，**这个模型不够简洁**。那么怎么解决这两个问题呢？我们要对这个模型进行抽象。



#### 模型简单化——抽象

企业、开发中心、开发组、直属部门，其实都是组织结构中的节点而已，从这一点来说，他们是有共性的，在业务上可以抽象为“组织”。

<img src="assets/%E9%A2%86%E5%9F%9F%E5%BB%BA%E6%A8%A1/9e62e2bc8c9264be8bfb8d9dd578cbb8.jpg" alt="img" style="zoom:25%;" />

经过抽象后，模型变简单了，但是无法区分出一个组织到底是开发组还是开发中心了，也就是**归纳了共性，但个性却丢了**。这个时候可以增加一个新的实体，来体现个性。

<img src="assets/%E9%A2%86%E5%9F%9F%E5%BB%BA%E6%A8%A1/ce877f6d0c1d2f75366561c09babcb70.jpg" alt="img" style="zoom:25%;" />

为了怕以后读这个模型图的人不理解什么是组织类别，我们还可以加一个**注释**，用来举例说明有哪些组织类别。

<img src="assets/%E9%A2%86%E5%9F%9F%E5%BB%BA%E6%A8%A1/825c9dd6a61eda8aac97dec2647e9401.jpg" alt="img" style="zoom:25%;" />



#### 自关联

这个图还不能表示企业、开发中心、开发组等之间的**上下级关系**。这可以用组织这个实体上的“自关联”来表达。

<img src="assets/%E9%A2%86%E5%9F%9F%E5%BB%BA%E6%A8%A1/ecb8c0aa73f3e241a98d1878fef5yyac.jpg" alt="img" style="zoom:25%;" />



这个关联翻译成自然语言可以这么说：一**个组织可以有多个组织作为自己的下级；而一个组织只能有一个组织作为自己的上级**。这样就表现出了上下级的层级关系。这种一对多的自关联，实际上表达的是一种树形结构。

另外，在这个自关联的两端，有上级和下级两个词。它们在 UML 里称为“**角色**”（role）



#### 增加约束

为了说明“一个开发中心下面有多个开发组，而不是一个开发组下面有多个开发中心”这个业务规则，又另外加了一个注释。

<img src="assets/%E9%A2%86%E5%9F%9F%E5%BB%BA%E6%A8%A1/ca1151c6da0e426faaa53be38aed2f8d.jpg" alt="img" style="zoom:25%;" />



* 和一般性的注释不同，它的内容用大括号括起来了

* 和一般性的注释不同，凡是约束，必须在程序中的某个地方进行实现

* 约束也是一种业务规则，应该加进前面讲过的业务规则表

现在的图中还有一些其他业务规则没有表现出来：

* 只有企业才能作为租户，其他类别的组织不能作为租户
* 作为多租户系统，其实每一个实体都应该与租户有一个关联，说明这个实体是属于哪一个租户的，这样才能把不同租户的数据区分开

如果把这些关联都画出来，模型图中的线条就会太多了，变得非常混乱。这个时候就可以用约束去做以简化图形。

<img src="assets/%E9%A2%86%E5%9F%9F%E5%BB%BA%E6%A8%A1/547ecc1f79f1020a285e9c6aced41f8b.jpg" alt="img" style="zoom:25%;" />



#### 识别多对多

业务的角度，可以认为管理员和人事人员其实都是员工担任的岗位。

<img src="assets/%E9%A2%86%E5%9F%9F%E5%BB%BA%E6%A8%A1/65909b1a3449b0ac355e180a4757e0ae.jpg" alt="img" style="zoom:24%;" />



<img src="assets/%E9%A2%86%E5%9F%9F%E5%BB%BA%E6%A8%A1/7d95a011d79d57f38923ae5c147cd23b.jpg" alt="img" style="zoom:25%;" />

一个员工可以担任多个岗位，而一个岗位也可以有多个员工担任。**员工和岗位之间是“多对多”关联**。



#### 细化多重性

关联两端的 “1” 或者 “*” 称为“多重性”。

<img src="assets/%E9%A2%86%E5%9F%9F%E5%BB%BA%E6%A8%A1/8b78f20c7eb5931319644c2dfe26ccbe.jpg" alt="img" style="zoom:25%;" />

* 一个组织可以有没有员工或者多个员工

* 一个员工必须有一个组织

因此，可以将多重性进行细化。

<img src="assets/%E9%A2%86%E5%9F%9F%E5%BB%BA%E6%A8%A1/b0a00d1dffbcd3d7ca7177530222144d.jpg" alt="img" style="zoom:25%;" />

整体进行细化。

<img src="assets/%E9%A2%86%E5%9F%9F%E5%BB%BA%E6%A8%A1/df6a6dbb07c24ea19b5a6219f5fe7a87.jpg" alt="img" style="zoom:25%;" />



#### 深入理解多对多

上述是**租户管理和组织管理**的部分的建模过程。接下来是**项目管理部分**的建模。下图是事件风暴阶段对项目管理的分析结果图。

<img src="assets/%E9%A2%86%E5%9F%9F%E5%BB%BA%E6%A8%A1/529247a111134583dcf6f5d0ff6d5e28.jpg" alt="img" style="zoom:25%;" />

先假定每个名词都是一个实体。

<img src="assets/%E9%A2%86%E5%9F%9F%E5%BB%BA%E6%A8%A1/e9132cc67d55c0968ed4f77ceb25d016.jpg" alt="img" style="zoom: 25%;" />

每个客户有一个客户经理负责（客户经理也是员工），可以把客户添加到模型里。

<img src="assets/%E9%A2%86%E5%9F%9F%E5%BB%BA%E6%A8%A1/6ec056bdd9283e24d9cbcc5a776ca0db.jpg" alt="img" style="zoom:25%;" />

这里把客户经理当作了一个角色，员工和客户的关联翻译成自然语言就是“**一个员工可以充当多个客户的客户经理，而一个客户有且仅有一个员工作为他的客户经理**”。接下来是合同实体，**每个合同都有一个销售人员负责**。

<img src="assets/%E9%A2%86%E5%9F%9F%E5%BB%BA%E6%A8%A1/8d07b425aafda76973c84a459117b5f5.jpg" alt="img" style="zoom:25%;" />

客户经理也是销售人员，利用抽象工具，可以将客户经理抽象为销售人员，而负责合同的销售人员可以叫做合同经理。并且此处有两个业务规则：

* 只有销售人员才能作客户经理
* 只有销售人员才能作合同经理

<img src="assets/%E9%A2%86%E5%9F%9F%E5%BB%BA%E6%A8%A1/13e1de25f2fbcd634abd72be146d3f1a.jpg" alt="img" style="zoom:25%;" />

接下来是项目实体。**一个项目经理可以负责多个项目，一个项目有一个项目经理。**

<img src="assets/%E9%A2%86%E5%9F%9F%E5%BB%BA%E6%A8%A1/1f47ac2ff2cda39b24af0f95a061f560.jpg" alt="img" style="zoom:25%;" />

上述是**项目管理**部分的建模过程，接下来是**分配员工**的建模。

**一个项目成员可以在多个项目上，一个项目可以可以有多个项目经理。**并且存在一个业务规则：一个员工的预计投入百分比总和不能大于百分之百。

<img src="assets/%E9%A2%86%E5%9F%9F%E5%BB%BA%E6%A8%A1/0d4512cd39d0290e51a5d399a15f5c09.jpg" alt="img" style="zoom:25%;" />

这里可以看到，**两个实体之间，可以有多个关联**。不同的关联代表不同含义，数量关系也可以不同，可以用角色名来区分。

有一个关于投入百分比的规则，那么投入百分比这个属性应该记录在哪个实体上呢？这个百分比既不能记录在员工实体上，也不能记录在项目实体上，这是因为，只有员工和项目建立了项目成员这一关联的时候，记录投入百分比才是有意义的，也就是说，这个属性应该记录在这个多对多关联上。

<img src="assets/%E9%A2%86%E5%9F%9F%E5%BB%BA%E6%A8%A1/f26dc01b0db5ec19cc3a8fdc6ecfb8e4.jpg" alt="img" style="zoom:25%;" />

任何多对多关联，总能用类似的方法，通过引入一个表示关联的实体，拆成两个一对多的关联。

考虑到时间因素，有关投入百分比的业务规则可以进一步明确：

* 在任何时刻，一个人的预计投入百分比总和不能大于百分之百。
* 一个员工在同一个项目上的时间段不能重叠。

<img src="assets/%E9%A2%86%E5%9F%9F%E5%BB%BA%E6%A8%A1/d5f6f3840eb9524da8278cc87f6a7991.jpg" alt="img" style="zoom:25%;" />

上述是对**项目管理**不分的领域建模，接下来是对**工时管理**部分进行领域建模。

工时管理在事件风暴阶段只产生了一个领域名词：工时，可以把其加入建模图形当中。

<img src="assets/%E9%A2%86%E5%9F%9F%E5%BB%BA%E6%A8%A1/4bcd55521e97a76cea3bd7df3cacf351.jpg" alt="img" style="zoom:25%;" />

#### 识别操作

在事件风暴中还遗留了一个问题：**怎么处理客户经理上级、销售人员上级和项目经理上级这几个概念**？

客户经理、销售人员、项目经理，无非都是员工，所以他们的上级，其实都可以归纳为**取员工上级这个操作**。然后讨论出了取员工上级的逻辑：

* 如果员工不是所属组织的负责人，那么这个组织的负责人就是员工的上级；
* 如果员工就是所属组织的负责人，那么这个组织的上级组织的负责人就是这个员工的上级。

在上述逻辑中，我们又引入了一个**组织负责人**的概念。可以认为，负责人是员工在与组织的关联中充当的一种角色。进一步完善建模图形。

<img src="assets/%E9%A2%86%E5%9F%9F%E5%BB%BA%E6%A8%A1/7d26899edf0bce20a9c351c46da23357.jpg" alt="img" style="zoom:25%;" />

有几个要注意的地方：

* 为了表达组织的负责人，在员工和组织之间又增加了一个一对多关联，表示“一个员工可以作多个组织的负责人，而一个组织有且只有一个负责人”
* 在员工实体上增加了取上级这个操作。
* 用一个注解说明了取上级这个操作的业务逻辑

现在，领域模型已经覆盖了事件风暴中发现的所有领域概念，但是，是不是觉得这个图已经有点乱，不太容易理解了呢？



### 划分模块

之所以这个图不容易理解，是因为很多实体和关联混杂在一起，形成了一个“蜘蛛网”。但人的认知能力是有限的，面对这样一张复杂的对象网络，就产生了认知过载（cognitive overload）。解决这一问题的方法就是“模块化”。也就是说，把模型中的业务概念组织成若干高内聚的模块（module），而模块之间尽量低耦合。

> 学习感悟
>
> * 模块化是需要有一个过程的。一定是要先梳理出来整体，然后基于这个整体根据实际情况判断是否要进行模块化，如果需要进行模块化一定要遵循高内聚低耦合。

在 UML 中，可以用包来表示模块。包的符号是下面这样：

<img src="assets/%E9%A2%86%E5%9F%9F%E5%BB%BA%E6%A8%A1/7197514c032b23147a3531a8f5d8b67f.jpg" alt="img" style="zoom:25%;" />

采用如下方式划分模块。

<img src="assets/%E9%A2%86%E5%9F%9F%E5%BB%BA%E6%A8%A1/6434d5d6260ba74f967d71145eae0de9.jpg" alt="img" style="zoom:25%;" />

也就是说，我们把模型分成了 4 个模块，分别是

* 租户管理
* 组织管理
* 项目管理（包含了分配项目成员）
* 工时管理。

有了模块，我们就可以从宏观和微观两个层面理解模型。

宏观层面，不关系模块内部细节，可以在宏观层面上分析模块之间的依赖。

<img src="assets/%E9%A2%86%E5%9F%9F%E5%BB%BA%E6%A8%A1/22cf84702d9c9cff4518ab4b37e10c87.jpg" alt="img" style="zoom:25%;" />

微观层面，可以深入到模块内部，了解实体和关联等等的细节。

至此，领域建模基本结束。接下来进入查漏补缺阶段要做的两个事情：

* 完善业务规则
* 建立词汇表



## 完善业务规则

在做事件风暴时就开始识别业务规则了，在领域建模中又识别出了更多的规则，所以现在我们需要把这些规则补充到业务规则表之中。

<img src="assets/%E9%A2%86%E5%9F%9F%E5%BB%BA%E6%A8%A1/431d4ff99edbc65c54e9a9fb083e0b96.jpg" alt="img" style="zoom:25%;" />



## 建立词汇表

建立词汇表，也就是把事件风暴和领域模型中重要的词汇列成表，其主要有两个作用：

* 需要通过词汇表来规范领域模型中的词汇
* 可以用于后续编程中的命名

<img src="assets/%E9%A2%86%E5%9F%9F%E5%BB%BA%E6%A8%A1/92704b55b0a605e9cf29c3992f76d10f.jpg" alt="img" style="zoom:25%;" />